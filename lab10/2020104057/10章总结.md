## C++编程思想第10章

### 复制构造函数

复制构造函数是一种特殊的构造函数，用于创建一个新对象并将其初始化为同类对象的副本。它接受一个同类对象作为参数，并使用该对象的数据来初始化新对象。

通常用于：

通过使用另一个同类型的对象来初始化新创建的对象。

复制对象把它作为参数传递给函数。

复制对象，并从函数返回这个对象。

```c++
classname (const classname &obj)

 {
   // 构造函数的主体
}
```



### 赋值运算符重载

赋值运算符重载允许在已有对象上进行赋值操作。它定义了如何将一个对象的数据拷贝到另一个对象中，并返回被赋值的对象的引用。

重载函数的参数列表中只能有一个参数。类类型指的是当前类的类型，也就是说，返回的是当前类的对象的引用。

默认情况下，如果不为类提供赋值运算符，编译器也会自动为其添加一个赋值运算符。不过编译器添加的赋值运算符，只是傻瓜式地将 obj 对象中各个成员变量的值赋值给目标对象（浅拷贝），当类中有指针成员变量的时候可能无法正常地工作。

```c++
class MyClass
{

public:

   MyClass& **operator**=(**const** MyClass & obj); // 重载 = 赋值运算符

}
```



### 深拷贝与浅拷贝

深拷贝是指在进行对象复制时，不仅复制对象的值，还复制动态分配的内存资源；

浅拷贝只复制指向某个对象的指针，而不复制对象本身，新旧对象还是共享同一块内存。但深拷贝会另外创造一个一模一样的对象，新对象跟原对象不共享内存，修改新对象不会改到原对象。

把一个对象赋值给一个新的变量时，**赋的其实是该对象的在栈中的地址，而不是堆中的数据**。也就是两个对象指向的是同一个存储空间，无论哪个对象发生改变，其实都是改变的存储空间的内容，因此，两个对象是联动的。

浅拷贝是按位拷贝对象，**它会创建一个新对象**，这个对象有着原始对象属性值的一份精确拷贝。如果属性是基本类型，拷贝的就是基本类型的值；如果属性是内存地址（引用类型），拷贝的就是内存地址 ，因此如果其中一个对象改变了这个地址，就会影响到另一个对象。即默认拷贝构造函数只是对对象进行浅拷贝复制(逐个成员依次拷贝)，即只复制对象空间而不复制资源。

### 默认复制操作

如果没有显式定义复制构造函数和赋值运算符重载，编译器会自动生成默认的复制操作。默认复制操作执行的是浅拷贝，对于动态内存资源的管理可能会出现问题。

### 自定义复制操作


1. 一般类对象的内存模型

一般类对象的内存模型如下图所示：

![image] (https://user-images.githubusercontent.com/12233466/159907763-94686976-3108-435c-8975-839287416674.png)

其中，vptr是虚函数表指针，指向虚函数表。虚函数表中存放了虚函数的地址。

2. 继承类对象的内存模型

继承类对象的内存模型如下图所示：

![image] (https://user-images.githubusercontent.com/12233466/159907843-0424006c-9057-4110-a83a-a96956911502.png)

其中，vptr是虚函数表指针，指向虚函数表。虚函数表中存放了虚函数的地址。

3. 带虚函数的类对象的内存模型

带虚函数的类对象的内存模型如下图所示：

![image] (https://user-images.githubusercontent.com/12233466/159907922-41624408-2943-4662-930b-684423560938.png)

其中，vptr是虚函数表指针，指向虚函数表。虚函数表中存放了虚函数的地址。

4. 基类有虚函数的子类对象的内存模型

基类有虚函数的子类对象的内存模型如下图所示：

![image] (https://user-images.githubusercontent.com/12233466/159907994-37430503-7107-4303-863e-7647f2050581.png)

其中，vptr是虚函数表指针，指向虚函数表。虚函数表中存放了虚函数的地址。

5. 基类有虚函数且子类有自己的更多的虚函数的类对象的内存模型

基类有虚函数且子类有自己的更多的虚函数的类对象的内存模型如下图所示：

![image] (https://user-images.githubusercontent.com/12233466/159908062-0851525e-5209-4765-8078-71e697035587.png)

其中，vptr是虚函数表指针，指向虚函数表。虚函数表中存放了虚函数的地址。

6. 多继承的类对象的内存模型

多继承的类对象的内存模型如下图所示：

![image] (https://user-images.githubusercontent.com/12233466/159908129-115875c8-3088-4254-866c-598021051508.png)

其中，vptr是虚函数表指针，指向虚函数表。虚函数表中存放了虚函数的地址。

7. 虚基类的类对象的内存模型

虚基类的类对象的内存模型如下图所示：

![image] (https://user-images.githubusercontent.com/12233466/159908196-90845826-3519-436c-9894-475662351165.png)

其中，vptr是虚函数表指针，指向虚函数表。虚函数表中存放了虚函数的地址。

根据具体的需求，可以自定义复制构造函数和赋值运算符重载，实现深拷贝、避免资源泄露以及处理其他特殊情况。

### 赋值初始化

赋值初始化是通过赋值运算符或复制构造函数来完成对象初始化的一种方式。可以使用等号进行赋值初始化，也可以使用圆括号进行赋值初始化。
